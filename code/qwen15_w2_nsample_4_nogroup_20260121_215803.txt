==================== 任务启动信息 ====================
启动时间: 2026-01-21 21:58:03
当前目录: /export/home2/zihan/MoEQuant/code
模型名称: Qwen1.5-MoE-A2.7B
权重位数 (W_BITS): 2
样本数量 (N_SAMPLES): 4
显卡设置: CUDA_VISIBLE_DEVICES=0,1
保存路径: /dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_4_groupsize128.pth
校准数据: ./EBSS_data/ebss_qwen15_selfbuild_merged.jsonl
完整执行命令:
python fake_quant/main.py --model /dataset/common/pretrain_model/Qwen1.5-MoE-A2.7B --w_bits 2 --nsamples 4 --save_qmodel_path /dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_4_groupsize128.pth --EBSS_calib --AGQ_GPTQ
======================================================



Arguments: 
{'AGQ_GPTQ': True,
 'EBSS_calib': True,
 'a_asym': False,
 'a_bits': 16,
 'a_clip_ratio': 1.0,
 'a_dynamic_method': 'pertensor',
 'a_groupsize': -1,
 'act_order': False,
 'bsz': 1,
 'cal_dataset': 'wikitext2',
 'calib_path': './EBSS_data/ebss_qwen15_selfbuild_merged.jsonl',
 'capture_layer_io': False,
 'distribute': False,
 'do_smooth': False,
 'eval_dataset': 'wikitext2',
 'fp32_had': True,
 'fully_quant': False,
 'hf_token': None,
 'human_res': './res_moe_qwen15_base_w2_selfebss_nsample_4',
 'int8_down_proj': False,
 'k_asym': False,
 'k_bits': 16,
 'k_clip_ratio': 1.0,
 'k_groupsize': -1,
 'k_pre_rope': False,
 'layer_idx': 10,
 'lm_eval': False,
 'lm_eval_batch_size': 128,
 'load_qmodel_path': None,
 'model': '/dataset/common/pretrain_model/Qwen1.5-MoE-A2.7B',
 'nsamples': 4,
 'online_hadamard': False,
 'percdamp': 0.01,
 'pre_eval': False,
 'quant_test': True,
 'rotate': False,
 'rotate_mode': 'hadamard',
 'rotation_seed': -1,
 'save_name': '20260121_215821',
 'save_path': '/export/home2/zihan/MoEQuant/code/log',
 'save_qmodel_path': '/dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_4_groupsize128.pth',
 'seed': 0,
 'shared_expert_act_calib': False,
 'static_test': False,
 'tasks': ['piqa',
           'hellaswag',
           'arc_easy',
           'arc_challenge',
           'winogrande',
           'lambada'],
 'v_asym': False,
 'v_bits': 16,
 'v_clip_ratio': 1.0,
 'v_groupsize': -1,
 'w_asym': False,
 'w_bits': 2,
 'w_clip': True,
 'w_groupsize': -1,
 'w_rtn': False,
 'wandb': False,
 'wandb_id': None,
 'wandb_project': None}
------------------------------------------------------------
---> Loading model with device_map=auto for multi-GPU support...
`torch_dtype` is deprecated! Use `dtype` instead!
Loading checkpoint shards:   0%|          | 0/8 [00:00<?, ?it/s]Loading checkpoint shards:   0%|          | 0/8 [00:07<?, ?it/s]
Traceback (most recent call last):
  File "/export/home2/zihan/MoEQuant/code/fake_quant/main.py", line 399, in <module>
    main()
  File "/export/home2/zihan/MoEQuant/code/fake_quant/main.py", line 218, in main
    model = model_utils.get_model(args.model, args.hf_token, args)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/model_utils.py", line 252, in get_model
    return get_qwen(model_name, hf_token, args)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/model_utils.py", line 141, in get_qwen
    model = transformers.AutoModelForCausalLM.from_pretrained(
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/models/auto/auto_factory.py", line 604, in from_pretrained
    return model_class.from_pretrained(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/modeling_utils.py", line 277, in _wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/modeling_utils.py", line 5048, in from_pretrained
    ) = cls._load_pretrained_model(
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/modeling_utils.py", line 5468, in _load_pretrained_model
    _error_msgs, disk_offload_index = load_shard_file(args)
                                      ^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/modeling_utils.py", line 843, in load_shard_file
    disk_offload_index = _load_state_dict_into_meta_model(
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/utils/_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/transformers/modeling_utils.py", line 770, in _load_state_dict_into_meta_model
    _load_parameter_into_model(model, param_name, param.to(param_device))
                                                  ^^^^^^^^^^^^^^^^^^^^^^
torch.cuda.OutOfMemoryError: CUDA out of memory. Tried to allocate 20.00 MiB. GPU 1 has a total capacity of 39.49 GiB of which 6.00 MiB is free. Process 2555826 has 36.88 GiB memory in use. Including non-PyTorch memory, this process has 2.60 GiB memory in use. Of the allocated memory 1.99 GiB is allocated by PyTorch, and 207.24 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
