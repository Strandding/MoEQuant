==================== 任务启动信息 ====================
启动时间: 2026-01-23 13:52:47
当前目录: /export/home2/zihan/MoEQuant/code
模型名称: Qwen1.5-MoE-A2.7B
权重位数 (W_BITS): 2
样本数量 (N_SAMPLES): 512
显卡设置: CUDA_VISIBLE_DEVICES=5
保存路径: /dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_512_groupsize128_rotate.pth
校准数据: ./EBSS_data/ebss_qwen15_selfbuild_merged_len512.jsonl
完整执行命令:
python fake_quant/main.py --model /dataset/common/pretrain_model/Qwen1.5-MoE-A2.7B --w_bits 2 --nsamples 512 --save_qmodel_path /dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_512_groupsize128_rotate.pth --EBSS_calib --AGQ_GPTQ
======================================================



Arguments: 
{'AGQ_GPTQ': True,
 'EBSS_calib': True,
 'a_asym': False,
 'a_bits': 16,
 'a_clip_ratio': 1.0,
 'a_dynamic_method': 'pertensor',
 'a_groupsize': 128,
 'act_order': False,
 'bsz': 1,
 'cal_dataset': 'wikitext2',
 'calib_path': './EBSS_data/ebss_qwen15_selfbuild_merged_len512.jsonl',
 'capture_layer_io': False,
 'distribute': False,
 'do_smooth': False,
 'eval_dataset': 'wikitext2',
 'fp32_had': True,
 'fully_quant': False,
 'hf_token': None,
 'human_res': './res_moe_qwen15_base_w2_selfebss_nsample_512',
 'int8_down_proj': False,
 'k_asym': False,
 'k_bits': 16,
 'k_clip_ratio': 1.0,
 'k_groupsize': -1,
 'k_pre_rope': False,
 'layer_idx': 10,
 'lm_eval': False,
 'lm_eval_batch_size': 128,
 'load_qmodel_path': None,
 'model': '/dataset/common/pretrain_model/Qwen1.5-MoE-A2.7B',
 'nsamples': 512,
 'online_hadamard': False,
 'percdamp': 0.01,
 'pre_eval': False,
 'quant_test': True,
 'rotate': True,
 'rotate_mode': 'hadamard',
 'rotation_seed': -1,
 'save_name': '20260123_135306',
 'save_path': '/export/home2/zihan/MoEQuant/code/log',
 'save_qmodel_path': '/dataset/common/quant_model/moequant_qwen15_w2_selfebss_nsample_512_groupsize128_rotate.pth',
 'seed': 0,
 'shared_expert_act_calib': False,
 'static_test': False,
 'tasks': ['piqa',
           'hellaswag',
           'arc_easy',
           'arc_challenge',
           'winogrande',
           'lambada'],
 'v_asym': False,
 'v_bits': 16,
 'v_clip_ratio': 1.0,
 'v_groupsize': -1,
 'w_asym': False,
 'w_bits': 2,
 'w_clip': True,
 'w_groupsize': 128,
 'w_rtn': False,
 'wandb': False,
 'wandb_id': None,
 'wandb_project': None}
------------------------------------------------------------
---> Loading model with device_map=auto for multi-GPU support...
`torch_dtype` is deprecated! Use `dtype` instead!
We will use 90% of the memory on device 0 for storing the model, and 10% for the buffer to avoid OOM. You can set `max_memory` in to a higher value to use more memory (at your own risk).
Loading checkpoint shards:   0%|          | 0/8 [00:00<?, ?it/s]Loading checkpoint shards:  12%|█▎        | 1/8 [00:00<00:06,  1.02it/s]Loading checkpoint shards:  25%|██▌       | 2/8 [00:02<00:07,  1.32s/it]Loading checkpoint shards:  38%|███▊      | 3/8 [00:03<00:05,  1.18s/it]Loading checkpoint shards:  50%|█████     | 4/8 [00:04<00:04,  1.08s/it]Loading checkpoint shards:  62%|██████▎   | 5/8 [00:05<00:03,  1.06s/it]Loading checkpoint shards:  75%|███████▌  | 6/8 [00:06<00:02,  1.06s/it]Loading checkpoint shards:  88%|████████▊ | 7/8 [00:08<00:01,  1.21s/it]Loading checkpoint shards: 100%|██████████| 8/8 [00:08<00:00,  1.15it/s]Loading checkpoint shards: 100%|██████████| 8/8 [00:08<00:00,  1.03s/it]
---> Loading /dataset/common/pretrain_model/Qwen1.5-MoE-A2.7B Model (class: Qwen2MoeForCausalLM) with seq_len: 2048
---> Using model-level rotary_emb for quantization
Token indices sequence length is longer than the specified maximum sequence length for this model (299078 > 32768). Running this sequence through the model will result in indexing errors
正在使用fuse_layer_norms
Fusing Layer Norms:   0%|          | 0/24 [00:00<?, ?layer/s]Fusing Layer Norms:  50%|█████     | 12/24 [00:00<00:00, 111.83layer/s]Fusing Layer Norms: 100%|██████████| 24/24 [00:00<00:00, 95.70layer/s] Fusing Layer Norms: 100%|██████████| 24/24 [00:00<00:00, 97.76layer/s]
GPU memory (from rotate_model): 34.25 -> 27.29 GB (-6.96 GB)
Rotating:   0%|          | 0/24 [00:00<?, ?layer/s]Rotating:   4%|▍         | 1/24 [00:00<00:02,  9.46layer/s]Rotating:  12%|█▎        | 3/24 [00:00<00:01, 12.95layer/s]Rotating:  21%|██        | 5/24 [00:00<00:02,  9.01layer/s]Rotating:  29%|██▉       | 7/24 [00:00<00:02,  8.03layer/s]Rotating:  33%|███▎      | 8/24 [00:00<00:02,  7.76layer/s]Rotating:  38%|███▊      | 9/24 [00:01<00:01,  7.55layer/s]Rotating:  42%|████▏     | 10/24 [00:01<00:01,  7.40layer/s]Rotating:  46%|████▌     | 11/24 [00:01<00:01,  7.29layer/s]Rotating:  50%|█████     | 12/24 [00:01<00:01,  7.20layer/s]Rotating:  54%|█████▍    | 13/24 [00:01<00:01,  7.14layer/s]Rotating:  58%|█████▊    | 14/24 [00:01<00:01,  7.10layer/s]Rotating:  62%|██████▎   | 15/24 [00:01<00:01,  7.07layer/s]Rotating:  67%|██████▋   | 16/24 [00:02<00:01,  7.04layer/s]Rotating:  71%|███████   | 17/24 [00:02<00:00,  7.03layer/s]Rotating:  75%|███████▌  | 18/24 [00:02<00:00,  7.01layer/s]Rotating:  79%|███████▉  | 19/24 [00:02<00:00,  7.01layer/s]Rotating:  83%|████████▎ | 20/24 [00:02<00:00,  7.00layer/s]Rotating:  88%|████████▊ | 21/24 [00:02<00:00,  7.00layer/s]Rotating:  92%|█████████▏| 22/24 [00:02<00:00,  7.00layer/s]Rotating:  96%|█████████▌| 23/24 [00:03<00:00,  6.99layer/s]Rotating: 100%|██████████| 24/24 [00:03<00:00,  6.99layer/s]Rotating: 100%|██████████| 24/24 [00:03<00:00,  7.40layer/s]
GPU memory (from main): 27.29 -> 27.27 GB (-0.02 GB)
-----GPTQ Quantization-----

Layer 0: mlp.experts.0.gate_proj  mlp.experts.0.up_proj  mlp.experts.1.gate_proj  mlp.experts.1.up_proj  mlp.experts.2.gate_proj  mlp.experts.2.up_proj  mlp.experts.3.gate_proj  mlp.experts.3.up_proj  mlp.experts.4.gate_proj  mlp.experts.4.up_proj  mlp.experts.5.gate_proj  mlp.experts.5.up_proj  mlp.experts.6.gate_proj  mlp.experts.6.up_proj  mlp.experts.7.gate_proj  mlp.experts.7.up_proj  mlp.experts.8.gate_proj  mlp.experts.8.up_proj  mlp.experts.9.gate_proj  mlp.experts.9.up_proj  mlp.experts.10.gate_proj  mlp.experts.10.up_proj  mlp.experts.11.gate_proj  mlp.experts.11.up_proj  mlp.experts.12.gate_proj  mlp.experts.12.up_proj  mlp.experts.13.gate_proj  mlp.experts.13.up_proj  mlp.experts.14.gate_proj  mlp.experts.14.up_proj  mlp.experts.15.gate_proj  mlp.experts.15.up_proj  mlp.experts.16.gate_proj  mlp.experts.16.up_proj  mlp.experts.17.gate_proj  mlp.experts.17.up_proj  mlp.experts.18.gate_proj  mlp.experts.18.up_proj  mlp.experts.19.gate_proj  Traceback (most recent call last):
  File "/export/home2/zihan/MoEQuant/code/fake_quant/main.py", line 406, in <module>
    if __name__ == '__main__':
        ^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/main.py", line 326, in main
    if args.AGQ_GPTQ:
                     ^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/utils/_contextlib.py", line 115, in decorate_context
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/gptq_utils_moe.py", line 485, in gptq_fwrd
    outs[jjj] = _unpack_layer_output(layer(
                                     ^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/quant_layers/quant_layer.py", line 441, in forward
    breakpoint()
                ^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/quant_layers/quant_layer.py", line 142, in forward
    current_hidden_states = expert_layer(current_state) * routing_weights[top_x, idx, None]
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1520, in _call_impl
    return forward_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/quant_layers/quant_layer.py", line 55, in forward
    gate_proj_rst = self.gate_proj(x)
                    ^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1511, in _wrapped_call_impl
    return self._call_impl(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/miniconda3/envs/moe/lib/python3.11/site-packages/torch/nn/modules/module.py", line 1574, in _call_impl
    hook_result = hook(self, args, result)
                  ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/export/home2/zihan/MoEQuant/code/fake_quant/gptq_utils_moe.py", line 448, in tmp
    gptq[name].add_batch_score(routing_scores,selected_experts,expert_num, expert_sum, inp[0].data, out.data)
  File "/export/home2/zihan/MoEQuant/code/fake_quant/gptq_utils_moe.py", line 41, in add_batch_score
    expert_mask = torch.nn.functional.one_hot(selected_experts[self.layer.cur_sample], num_classes=expert_sum).permute(2, 1, 0)
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
KeyboardInterrupt
